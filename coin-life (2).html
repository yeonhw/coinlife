<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>模拟币生 Coin Life</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
        
        :root {
            --pixel-bg: #1a1b26;
            --pixel-green: #4ade80;
            --pixel-red: #ef4444;
            --pixel-gold: #fbbf24;
            --pixel-neon-blue: #00f3ff;
            --pixel-neon-pink: #ff00ff;
        }
        
        body {
            font-family: 'VT323', monospace;
            background-color: var(--pixel-bg);
            color: white;
            overflow: hidden;
            touch-action: none;
            image-rendering: pixelated;
        }
        
        /* 像素字体增强 */
        .pixel-font {
            font-family: 'VT323', monospace;
        }
        
        /* 霓虹灯效果 */
        .neon-text-blue {
            text-shadow: 0 0 5px var(--pixel-neon-blue), 0 0 10px var(--pixel-neon-blue);
        }
        
        .neon-text-pink {
            text-shadow: 0 0 5px var(--pixel-neon-pink), 0 0 10px var(--pixel-neon-pink);
        }
        
        /* 游戏容器 */
        #game-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            background: #0f172a;
        }
        
        /* 状态覆盖层 */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            transition: opacity 0.5s;
        }
        
        .hidden-screen {
            opacity: 0;
            pointer-events: none;
            z-index: -1;
        }
        
        /* 像素按钮 */
        .pixel-btn {
            background: #3b82f6;
            border: 4px solid #1d4ed8;
            box-shadow: 4px 4px 0px #000;
            color: white;
            padding: 10px 20px;
            font-size: 1.5rem;
            cursor: pointer;
            transition: transform 0.1s;
        }
        
        .pixel-btn:active {
            transform: translate(4px, 4px);
            box-shadow: 0px 0px 0px #000;
        }
        
        /* 滑块样式 */
        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            background: transparent;
        }
        
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            height: 30px;
            width: 15px;
            background: #ffffff;
            border: 2px solid #000;
            cursor: pointer;
            margin-top: -12px;
            box-shadow: 2px 2px 0 #000;
        }
        
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 8px;
            cursor: pointer;
            background: linear-gradient(to right, #ef4444 0%, #ef4444 45%, #ffffff 45%, #ffffff 55%, #4ade80 55%, #4ade80 100%);
            border: 2px solid #000;
        }
        
        /* 弹幕动画 */
        .danmaku {
            position: absolute;
            white-space: nowrap;
            font-size: 1.2rem;
            text-shadow: 1px 1px 0 #000;
            animation: fly-left 4s linear forwards;
            pointer-events: none;
        }
        
        @keyframes fly-left {
            from { left: 100%; }
            to { left: -100%; }
        }
        
        /* 城市背景动画 */
        .city-bg {
            background-image: linear-gradient(transparent 90%, rgba(0,243,255,0.1) 90%),
                              linear-gradient(90deg, transparent 90%, rgba(0,243,255,0.1) 90%);
            background-size: 20px 20px;
            animation: scroll-city 20s linear infinite;
        }
        
        @keyframes scroll-city {
            from { background-position: 0 0; }
            to { background-position: 0 100%; }
        }
    </style>
</head>
<body>
    <div id="game-container" class="relative overflow-hidden">
        <!-- Canvas Layer for Night Rendering -->
        <canvas id="gameCanvas" class="absolute top-0 left-0 w-full h-full z-0"></canvas>
        
        <!-- 1. Start Screen -->
        <div id="start-screen" class="screen city-bg bg-slate-900">
            <div class="text-center relative z-20 p-6 border-4 border-white bg-black/80 shadow-[8px_8px_0_0_#000]">
                <h1 class="text-6xl mb-2 neon-text-blue tracking-widest pixel-font">COIN LIFE</h1>
                <p class="text-2xl mb-8 neon-text-pink pixel-font">模拟币生</p>
                <div class="flex justify-center space-x-8 mb-8 text-yellow-400 animate-pulse">
                    <span>BTC</span>
                    <span>ETH</span>
                    <span>DOGE</span>
                </div>
                <button id="btn-start" class="pixel-btn bg-green-500 border-green-700 w-full">START GAME</button>
                <div class="mt-4 text-gray-400 text-sm pixel-font">7 Days to Financial Freedom... or Ruin.</div>
            </div>
            <!-- Deco bottom -->
            <div class="absolute bottom-10 flex space-x-6">
                <i data-lucide="trophy" class="w-8 h-8 text-yellow-500"></i>
                <i data-lucide="history" class="w-8 h-8 text-blue-400"></i>
            </div>
        </div>
        
        <!-- 2. Day Screen (Decision) -->
        <div id="day-screen" class="screen hidden-screen bg-slate-800/95 backdrop-blur-sm z-20">
            <div class="w-full max-w-lg p-6 flex flex-col h-full">
                <!-- Header -->
                <div class="flex justify-between items-center mb-6 border-b-2 border-white pb-4">
                    <span class="text-3xl text-yellow-400 pixel-font font-bold">Day <span id="day-num">1</span>/7</span>
                    <div class="text-right">
                        <div class="text-sm text-gray-400">Total Assets</div>
                        <div class="text-3xl pixel-font text-green-400 font-bold">$<span id="total-assets">1000</span></div>
                    </div>
                </div>
                
                <!-- PnL Display (显示昨晚盈亏，第一天不显示) -->
                <div id="pnl-section" class="mb-6 text-center hidden">
                    <div class="text-2xl pixel-font font-bold mb-2">
                        <span id="pnl-text" class="text-red-400">You lose $50(10%) in the night!</span>
                    </div>
                </div>
                
                <!-- Current Price -->
                <div class="text-center mb-6">
                    <div class="text-lg text-gray-400 mb-2">Current Price</div>
                    <div class="text-6xl neon-text-blue pixel-font font-bold">$<span id="current-price-display">10</span></div>
                </div>
                
                <!-- News Section -->
                <div class="mb-6">
                    <div class="text-xl text-white mb-3 pixel-font font-bold">Today you hear</div>
                    <div class="bg-black/50 border-2 border-gray-600 p-4 relative">
                        <div class="absolute top-2 right-2 bg-red-500 text-white text-xs px-2 py-1 font-bold">NEWS</div>
                        <p id="daily-news" class="text-lg leading-tight pixel-font text-blue-200">某大型交易所插针，全网爆仓。</p>
                        <div id="news-effect" class="text-sm text-gray-500 mt-2 italic">市场情绪波动中...</div>
                    </div>
                </div>
                
                <!-- Trading Decision -->
                <div class="mt-auto">
                    <div class="flex justify-between items-center mb-4">
                        <div class="text-xl text-white pixel-font font-bold">You decide to</div>
                        <div class="text-right">
                            <div class="text-sm text-gray-400">Cash / Amount</div>
                            <div class="text-lg pixel-font text-green-400">$<span id="cash-balance">1000</span></div>
                            <div class="text-lg pixel-font text-blue-400"><span id="amount-balance">0</span> coins</div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-900 border-4 border-white p-6 shadow-[8px_8px_0_0_#000]">
                        <!-- Slider Labels -->
                        <div class="flex justify-between text-lg mb-3 font-bold pixel-font">
                            <span class="text-red-400">Sell</span>
                            <span class="text-gray-400">Hold</span>
                            <span class="text-green-400">Buy</span>
                        </div>
                        
                        <!-- Slider -->
                        <input type="range" id="trade-slider" min="0" max="100" value="50" step="1" class="mb-4">
                        
                        <!-- Action Display -->
                        <div class="text-center mb-6">
                            <div class="text-2xl pixel-font font-bold">Action: <span id="action-text" class="text-yellow-400">Hold</span></div>
                        </div>
                        
                        <!-- Sleep Button -->
                        <button id="btn-sleep" class="pixel-btn bg-indigo-600 border-indigo-800 w-full text-2xl py-4 font-bold">SLEEP & NEXT DAY</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 3. Night HUD (Overlay on Canvas) -->
        <div id="night-hud" class="absolute top-0 left-0 w-full h-full pointer-events-none z-10 hidden">
            <div class="absolute top-4 left-4 text-xl pixel-font bg-black/50 px-2 text-white border border-white">DAY <span id="night-day-num">1</span></div>
            <div class="absolute top-4 right-4 text-right">
                <div id="night-pnl" class="text-3xl pixel-font font-bold text-gray-100">0%</div>
                <div class="text-xs text-gray-400">NIGHT PNL</div>
            </div>
            <!-- Bullet comments container -->
            <div id="danmaku-container" class="absolute top-20 left-0 w-full h-64 overflow-hidden"></div>
        </div>
        
        <!-- 4. End Screen -->
        <div id="end-screen" class="screen hidden-screen bg-black z-30">
            <div class="w-full max-w-md p-6 border-4 border-white bg-slate-900 text-center relative">
                <div class="absolute -top-6 left-1/2 transform -translate-x-1/2 bg-yellow-500 text-black px-4 py-1 font-bold border-2 border-white shadow-[4px_4px_0_0_#fff]">FINAL JUDGMENT</div>
                <h2 class="text-3xl mt-6 mb-2 pixel-font text-white">GAME OVER</h2>
                <div class="mb-6">
                    <p class="text-gray-400 text-sm">Final Assets</p>
                    <p class="text-5xl neon-text-blue pixel-font">$<span id="final-score">0</span></p>
                    <p id="roi-text" class="text-lg mt-1"></p>
                </div>
                
                <!-- Personality Card -->
                <div class="bg-gray-800 p-4 mb-6 border-2 border-gray-600">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-gray-400 text-xs">TITLE</span>
                        <span class="text-gray-400 text-xs">ID: MAGGIE_PM</span>
                    </div>
                    <h3 id="player-title" class="text-2xl text-yellow-400 font-bold mb-2 pixel-font">DIAMOND HANDS</h3>
                    <p id="flavor-text" class="text-sm text-left text-gray-300 italic font-serif leading-relaxed">"..."</p>
                </div>
                
                <!-- Simple CSS Radar Chart Viz -->
                <div class="flex justify-center space-x-1 mb-6 h-20 items-end">
                    <div class="w-8 bg-red-500 relative group">
                        <div class="absolute -top-6 text-xs w-full text-center hidden group-hover:block">Greed</div>
                        <div id="bar-greed" style="height: 50%" class="w-full bg-red-500 border border-white"></div>
                    </div>
                    <div class="w-8 bg-blue-500 relative group">
                        <div class="absolute -top-6 text-xs w-full text-center hidden group-hover:block">Fear</div>
                        <div id="bar-fear" style="height: 50%" class="w-full bg-blue-500 border border-white"></div>
                    </div>
                    <div class="w-8 bg-green-500 relative group">
                        <div class="absolute -top-6 text-xs w-full text-center hidden group-hover:block">Luck</div>
                        <div id="bar-luck" style="height: 50%" class="w-full bg-green-500 border border-white"></div>
                    </div>
                    <div class="w-8 bg-purple-500 relative group">
                        <div class="absolute -top-6 text-xs w-full text-center hidden group-hover:block">Guts</div>
                        <div id="bar-guts" style="height: 50%" class="w-full bg-purple-500 border border-white"></div>
                    </div>
                </div>
                
                <button id="btn-restart" class="pixel-btn bg-white text-black border-gray-400 w-full">TRY AGAIN</button>
            </div>
        </div>
    </div>
    <script>
        // --- 8-bit Audio System ---
        const AudioSys = {
            ctx: null,
            init: function() {
                window.AudioContext = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AudioContext();
            },
            playTone: function(freq, type, duration) {
                if (!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type; // square, sawtooth, triangle, sine
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            },
            click: function() { this.playTone(440, 'square', 0.1); },
            coin: function() { 
                this.playTone(1200, 'square', 0.1); 
                setTimeout(() => this.playTone(1600, 'square', 0.2), 100);
            },
            explosion: function() { this.playTone(100, 'sawtooth', 0.5); },
            jump: function() {
                if (!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.frequency.setValueAtTime(200, this.ctx.currentTime);
                osc.frequency.linearRampToValueAtTime(600, this.ctx.currentTime + 0.2);
                gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + 0.2);
            }
        };

        // --- Game State ---
        const State = {
            day: 1,
            maxDays: 7,
            cash: 1000, // 现金 (USDT)
            amount: 0,  // 持仓数量 (COIN)
            price: 10,  // 当前价格
            priceYesterday: 10, // 昨日价格
            totalAssetsYesterday: 1000, // 昨日总资产
            lastNightPnL: 0, // 昨晚盈亏
            lastNightPnLPercent: 0, // 昨晚盈亏百分比
            history: [], // For K-line
            nightHistory: [], // Micro-movements during night
            nightTargetPrice: 0, // 夜间目标价格
            currentEvent: null, // 当日事件
            nextDayChange: 0, // 次日涨跌幅
            eventHistory: [], // 记录所有事件历史
            alphaHistory: [], // 记录每日alpha值
            totalHistory: [], // 记录每日总资产
            minTotalReached: 1000, // 历史最低总资产
            maxTotalReached: 1000, // 历史最高总资产
            stats: {
                trades: 0,
                allIns: 0,
                panicSells: 0,
                maxProfit: 0,
                maxLoss: 0,
                bullishEvents: 0, // 利好事件计数
                bearishEvents: 0, // 利空事件计数
                blackSwanEvents: 0, // 黑天鹅事件计数
                contraryActions: 0, // 反向操作计数
                luckEvents: 0, // 幸运事件计数（利好事件且持仓>0）
                changeCount: 0, // 仓位变动次数
                maxDrawdown: 0, // 最大回撤
                timingScore: 50, // 择时得分 (0-100)
                avgAlpha: 0 // 平均alpha值
            },
            pendingAction: 'HOLD', // BUY, SELL, HOLD
            pendingAmount: 0, // Amount in percentage 0-100
            sliderValue: 50 // 滑杆位置 (0-100)
        };

        // 7日事件池 - 按天数和类型分类
        const EventPools = {
            D1: { // 种子期
                '利好-A': { text: "获得顶级 VC 种子轮融资，机构背书极强。", range: [25, 35], tier: 'A' },
                '利好-B': { text: "测试网运行极其流畅，TPS 突破预期。", range: [10, 15], tier: 'B' },
                '利空-A': { text: "某大 V 质疑其核心代码全是复用 PPT。", range: [-18, -12], tier: 'B' },
                '利空-B': { text: "核心开发者被爆出曾有\"归零项目\"前科。", range: [-25, -15], tier: 'A' },
                '黑天鹅': { text: "创始人身份造假，实为在逃惯犯。", range: [-99, -99], tier: 'S+' },
                '噪音': { text: "市场恐慌与贪婪指数为 50，波动细微。", range: [-1, 1], tier: 'C' }
            },
            D2: { // 发酵期
                '利好-A': { text: "某顶级 KOL 宣布加入顾问委员会。", range: [15, 20], tier: 'B' },
                '利好-B': { text: "社区喊话\"大的要来了\"，群友刷屏 LFG。", range: [8, 12], tier: 'B' },
                '利空-A': { text: "电报群遭黑客潜入，发放虚假预售链接。", range: [-20, -15], tier: 'B' },
                '利空-B': { text: "监测到项目方多签钱包有 5% 筹码移动。", range: [-30, -20], tier: 'A' },
                '黑天鹅': { text: "某主权国家宣布将该技术用于国家骨干网。", range: [150, 200], tier: 'S+' }
            },
            D3: { // 上线期
                '利好-A': { text: "顶级交易所正式宣布开启合约交易。", range: [35, 50], tier: 'A' },
                '利好-B': { text: "上线首小时交易额突破 1 亿美元。", range: [12, 18], tier: 'B' },
                '利空-A': { text: "早期种子轮投资者开始大规模获利砸盘。", range: [-35, -25], tier: 'A' },
                '利空-B': { text: "创始人因\"不可抗力\"突然失联。", range: [-60, -40], tier: 'S' },
                '黑天鹅': { text: "被指控涉嫌洗钱，全网交易所强制下架。", range: [-99, -95], tier: 'S+' }
            },
            D4: { // 生态期
                '利好-A': { text: "宣布与主流 Layer 2 达成战略协作。", range: [15, 25], tier: 'A' },
                '利好-B': { text: "质押池（Staking）上线，锁仓量飙升。", range: [10, 15], tier: 'B' },
                '利空-A': { text: "官方推特被盗，发布利空虚假澄清。", range: [-30, -20], tier: 'B' },
                '利空-B': { text: "SEC 发布监管函，质疑其属于证券。", range: [-35, -25], tier: 'A' },
                '噪音': { text: "机器人账号在 X 平台转发虚假空投。", range: [-3, -1], tier: 'C' }
            },
            D5: { // 博弈期
                '利好-A': { text: "监测到远古巨鲸高价吸筹并锁仓。", range: [25, 35], tier: 'A' },
                '利好-B': { text: "项目方宣布启动大规模回购计划。", range: [12, 20], tier: 'B' },
                '利空-A': { text: "某巨鲸将巨量沉睡筹码转入交易所准备套现。", range: [-45, -30], tier: 'A' },
                '利空-B': { text: "传闻某大户因爆仓被强制平仓。", range: [-20, -15], tier: 'B' },
                '黑天鹅': { text: "主流稳定币突然脱锚，引发全网去杠杆抛售。", range: [-70, -60], tier: 'S+' }
            },
            D6: { // 危机期
                '利好-A': { text: "聪明钱地址在暴跌中逆势抄底。", range: [12, 18], tier: 'B' },
                '利好-B': { text: "成功修复之前传闻的漏洞，技术安全性提升。", range: [8, 12], tier: 'B' },
                '利空-A': { text: "确认为安全漏洞，黑客已盗走部分资产。", range: [-30, -20], tier: 'S' },
                '利空-B': { text: "市场进入审美疲劳期，成交量萎缩 70%。", range: [-15, -10], tier: 'B' },
                '黑天鹅': { text: "那个卷毛骗了所有人！交易所金库空空如也。区块链要毁灭了，快逃！", range: [-99, -80], tier: 'S+' }
            },
            D7: { // 终局期
                '利好-A': { text: "官方销毁机制生效，总量缩减 20%。", range: [80, 150], tier: 'S' },
                '利好-B': { text: "宣布将迁移至性能更强的新链，获得重生。", range: [40, 60], tier: 'A' },
                '利空-A': { text: "核心合约遭重入攻击，池子被抽干。", range: [-99, -90], tier: 'S+' },
                '利空-B': { text: "创始人发布声明称\"累了\"。", range: [-35, -20], tier: 'S' }
            }
        };

        // --- DOM Elements ---
        const screens = {
            start: document.getElementById('start-screen'),
            day: document.getElementById('day-screen'),
            end: document.getElementById('end-screen'),
            hud: document.getElementById('night-hud')
        };

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // --- Core Logic ---
        function initGame() {
            console.log('Initializing game...');
            console.log('Document ready state:', document.readyState);
            
            try {
                lucide.createIcons();
                resizeCanvas();
                window.addEventListener('resize', resizeCanvas);

                // Start Button - 添加更强的错误处理
                const startBtn = document.getElementById('btn-start');
                console.log('Start button found:', startBtn);
                
                if (startBtn) {
                    // 移除可能存在的旧事件监听器
                    startBtn.replaceWith(startBtn.cloneNode(true));
                    const newStartBtn = document.getElementById('btn-start');
                    
                    newStartBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('Start button clicked!');
                        try {
                            AudioSys.init();
                            AudioSys.coin();
                            startGame();
                        } catch (error) {
                            console.error('Error starting game:', error);
                        }
                    });
                    
                    // 添加视觉反馈
                    newStartBtn.addEventListener('mousedown', () => {
                        newStartBtn.style.transform = 'translate(4px, 4px)';
                        newStartBtn.style.boxShadow = '0px 0px 0px #000';
                    });
                    
                    newStartBtn.addEventListener('mouseup', () => {
                        newStartBtn.style.transform = '';
                        newStartBtn.style.boxShadow = '4px 4px 0px #000';
                    });
                    
                    console.log('Start button event listeners attached successfully');
                } else {
                    console.error('Start button not found!');
                    // 尝试延迟重试
                    setTimeout(() => {
                        console.log('Retrying button initialization...');
                        initGame();
                    }, 100);
                    return;
                }
            } catch (error) {
                console.error('Error in initGame:', error);
            }

            // Slider Logic - 滑杆百分比：-1到1，中间为0（Hold）
            const slider = document.getElementById('trade-slider');
            slider.addEventListener('input', (e) => {
                const val = parseInt(e.target.value);
                
                // 将滑杆值0-100转换为-1到1的alpha值
                const alpha = (val - 50) / 50; // 0->-1, 50->0, 100->1
                
                // 检查限制条件
                if (alpha < 0 && State.amount <= 0) {
                    // 没有持仓时不能卖出，强制回到中间位置
                    slider.value = 50;
                    State.sliderValue = 50;
                    document.getElementById('action-text').innerText = "Hold";
                    document.getElementById('action-text').className = "text-yellow-400 font-bold";
                    State.pendingAction = 'HOLD';
                    return;
                }
                
                if (alpha > 0 && State.cash <= 0) {
                    // 没有现金时不能买入，强制回到中间位置
                    slider.value = 50;
                    State.sliderValue = 50;
                    document.getElementById('action-text').innerText = "Hold";
                    document.getElementById('action-text').className = "text-yellow-400 font-bold";
                    State.pendingAction = 'HOLD';
                    return;
                }
                
                State.sliderValue = val;
                const actionText = document.getElementById('action-text');
                
                if (alpha > 0.1) {
                    // 买入：alpha > 0，数值越大买入越多
                    const buyPercent = (alpha * 100).toFixed(0);
                    actionText.innerText = `Buy ${buyPercent}%`;
                    actionText.className = "text-green-400 font-bold";
                    State.pendingAction = 'BUY';
                } else if (alpha < -0.1) {
                    // 卖出：alpha < 0，数值越小卖出越多
                    const sellPercent = (Math.abs(alpha) * 100).toFixed(0);
                    actionText.innerText = `Sell ${sellPercent}%`;
                    actionText.className = "text-red-400 font-bold";
                    State.pendingAction = 'SELL';
                } else {
                    // 持有：alpha接近0
                    actionText.innerText = `Hold`;
                    actionText.className = "text-yellow-400 font-bold";
                    State.pendingAction = 'HOLD';
                }
            });

            // Sleep Button
            document.getElementById('btn-sleep').addEventListener('click', () => {
                AudioSys.click();
                executeTrade();
                startNight();
            });

            // Restart
            document.getElementById('btn-restart').addEventListener('click', () => {
                AudioSys.coin();
                resetState();
                switchScreen('start'); // 回到开始界面而不是直接进入游戏
            });
        }

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        function resetState() {
            State.day = 1;
            State.cash = 1000;
            State.amount = 0; // 初始持仓为0，符合游戏设定
            State.price = 10; // 初始开盘价 $10
            State.priceYesterday = 10;
            State.totalAssetsYesterday = 1000;
            State.lastNightPnL = 0;
            State.lastNightPnLPercent = 0;
            State.history = [10];
            State.eventHistory = [];
            State.alphaHistory = [];
            State.totalHistory = [1000];
            State.minTotalReached = 1000;
            State.maxTotalReached = 1000;
            State.currentEvent = null;
            State.nextDayChange = 0;
            State.sliderValue = 50;
            State.stats = { 
                trades: 0, 
                allIns: 0, 
                panicSells: 0, 
                maxProfit: 0, 
                maxLoss: 0,
                bullishEvents: 0,
                bearishEvents: 0,
                blackSwanEvents: 0,
                contraryActions: 0,
                luckEvents: 0,
                changeCount: 0,
                maxDrawdown: 0,
                timingScore: 50,
                avgAlpha: 0
            };
        }

        function startGame() {
            switchScreen('day');
            updateDayUI();
        }

        function switchScreen(name) {
            Object.values(screens).forEach(s => s.classList.add('hidden-screen'));
            
            if(name === 'night') {
                screens.hud.classList.remove('hidden');
            } else {
                screens.hud.classList.add('hidden');
                if (name === 'start') screens.start.classList.remove('hidden-screen');
                if (name === 'day') screens.day.classList.remove('hidden-screen');
                if (name === 'end') screens.end.classList.remove('hidden-screen');
            }
        }

        function generateDailyEvent() {
            const dayKey = `D${State.day}`;
            const dayPool = EventPools[dayKey];
            
            if (!dayPool) {
                // 如果没有对应天数的事件池，使用默认事件
                return {
                    type: '噪音',
                    text: "市场平静，没有重大消息。",
                    range: [-2, 2],
                    tier: 'C'
                };
            }
            
            // 从当日事件池中随机选择一个事件
            const eventTypes = Object.keys(dayPool);
            const randomType = eventTypes[Math.floor(Math.random() * eventTypes.length)];
            const event = dayPool[randomType];
            
            // 计算次日涨跌幅
            const [min, max] = event.range;
            const changePercent = min + Math.random() * (max - min);
            
            // 记录事件统计
            if (randomType.includes('利好')) {
                State.stats.bullishEvents++;
            } else if (randomType.includes('利空')) {
                State.stats.bearishEvents++;
            } else if (randomType === '黑天鹅') {
                State.stats.blackSwanEvents++;
            }
            
            return {
                type: randomType,
                text: event.text,
                changePercent: changePercent,
                tier: event.tier,
                range: event.range
            };
        }

        function updateDayUI() {
            const event = generateDailyEvent();
            State.currentEvent = event;
            State.nextDayChange = event.changePercent;
            
            // 记录事件历史
            State.eventHistory.push({
                day: State.day,
                event: event,
                priceBeforeEvent: State.price
            });
            
            // 计算总资产
            const totalAssets = Math.floor(State.cash + (State.amount * State.price));
            
            document.getElementById('day-num').innerText = State.day;
            document.getElementById('total-assets').innerText = totalAssets;
            document.getElementById('daily-news').innerText = event.text;
            document.getElementById('current-price-display').innerText = State.price.toFixed(0);
            document.getElementById('cash-balance').innerText = Math.floor(State.cash);
            document.getElementById('amount-balance').innerText = State.amount.toFixed(2);
            
            // 显示昨晚盈亏 (第一天不显示)
            const pnlSection = document.getElementById('pnl-section');
            if (State.day > 1) {
                pnlSection.classList.remove('hidden');
                const pnlText = document.getElementById('pnl-text');
                
                if (State.lastNightPnL >= 0) {
                    pnlText.innerText = `You gain $${Math.abs(State.lastNightPnL).toFixed(0)}(${State.lastNightPnLPercent.toFixed(1)}%) in the night!`;
                    pnlText.className = "text-green-400";
                } else {
                    pnlText.innerText = `You lose $${Math.abs(State.lastNightPnL).toFixed(0)}(${Math.abs(State.lastNightPnLPercent).toFixed(1)}%) in the night!`;
                    pnlText.className = "text-red-400";
                }
            } else {
                pnlSection.classList.add('hidden');
            }
            
            // 隐藏具体的事件等级和预期影响，只显示模糊的市场情绪
            const moodTexts = [
                "市场情绪波动中...",
                "投资者观望态度明显",
                "交易量出现异常变化", 
                "技术面信号混杂",
                "资金流向扑朔迷离"
            ];
            const randomMood = moodTexts[Math.floor(Math.random() * moodTexts.length)];
            document.getElementById('news-effect').innerText = randomMood;
            
            // Reset slider
            const slider = document.getElementById('trade-slider');
            slider.value = 50;
            State.sliderValue = 50;
            document.getElementById('action-text').innerText = "Hold";
            document.getElementById('action-text').className = "text-yellow-400 font-bold";
            State.pendingAction = 'HOLD';
        }

        function executeTrade() {
            // 保存交易前的状态
            const cashYesterday = State.cash;
            const amountYesterday = State.amount;
            
            // 检查反向操作逻辑
            const isBullishEvent = State.currentEvent && State.currentEvent.type.includes('利好');
            const isBearishEvent = State.currentEvent && State.currentEvent.type.includes('利空');
            
            // 将滑杆值0-100转换为-1到1的alpha值
            const alpha = (State.sliderValue - 50) / 50; // 0->-1, 50->0, 100->1
            
            // 记录alpha历史
            State.alphaHistory.push(alpha);
            
            // 检查仓位变动
            if (Math.abs(alpha) > 0.1) {
                State.stats.changeCount++;
            }
            
            if (alpha > 0) {
                // 买入操作：alpha > 0，用alpha比例的现金买入
                // 示例：alpha=0.5，用50%现金买入
                
                // 计算交易额：Cash_yesterday * alpha
                const tradeAmount = cashYesterday * alpha;
                
                // 扣除现金：Cash_new = Cash_yesterday - 交易额
                State.cash = cashYesterday - tradeAmount;
                
                // 增加持仓：Amount_new = Amount_yesterday + (交易额 / Price)
                State.amount = amountYesterday + (tradeAmount / State.price);
                
                State.stats.trades++;
                if (alpha > 0.9) State.stats.allIns++;
                if (isBearishEvent) State.stats.contraryActions++;
                
                // 择时得分：利好时买入加分
                if (isBullishEvent) {
                    State.stats.timingScore += 10;
                } else if (isBearishEvent) {
                    State.stats.timingScore -= 15;
                }
                
            } else if (alpha < 0) {
                // 卖出操作：alpha < 0，卖出|alpha|比例的持仓
                // 示例：alpha=-0.4，卖出40%持仓
                
                const sellRatio = Math.abs(alpha); // 0.0 ~ 1.0
                
                // 计算卖出数量：Amount_yesterday * sellRatio
                const sellAmount = amountYesterday * sellRatio;
                
                // 减少持仓：Amount_new = Amount_yesterday - 卖出数量
                State.amount = amountYesterday - sellAmount;
                
                // 增加现金：Cash_new = Cash_yesterday + (卖出数量 * Price)
                State.cash = cashYesterday + (sellAmount * State.price);
                
                State.stats.trades++;
                if (sellRatio > 0.9) State.stats.panicSells++;
                if (isBullishEvent) State.stats.contraryActions++;
                
                // 择时得分：利空时卖出加分
                if (isBearishEvent) {
                    State.stats.timingScore += 10;
                } else if (isBullishEvent) {
                    State.stats.timingScore -= 15;
                }
                
            } else {
                // HOLD: alpha = 0，不改变持仓和现金
                State.amount = amountYesterday;
                State.cash = cashYesterday;
            }
            
            // 确保数值不为负
            if (State.cash < 0) State.cash = 0;
            if (State.amount < 0) State.amount = 0;
            
            // 确保择时得分在0-100范围内
            State.stats.timingScore = Math.max(0, Math.min(100, State.stats.timingScore));
        }

        // --- NIGHT SIMULATION (The Core) ---
        let animationId;
        let nightProgress = 0;
        let nightDuration = 400; // Frames
        let currentNightPrice = 0;
        let particles = [];

        function startNight() {
            switchScreen('night');
            nightProgress = 0;
            State.nightHistory = [];
            currentNightPrice = State.price;
            particles = []; // Reset fireworks
            
            // 保存今日开始时的总资产用于PnL计算
            State.nightStartVal = State.cash + (State.amount * State.price);
            
            animateNight();
        }

        function animateNight() {
            ctx.fillStyle = '#0f172a'; // Night Sky
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw Stars
            ctx.fillStyle = '#FFF';
            if (Math.random() > 0.8) ctx.fillRect(Math.random()*canvas.width, Math.random()*canvas.height, 2, 2);
            
            nightProgress++;
            
            // 1. Calculate Price Movement - 基于事件驱动的价格变动，增强视觉效果
            let change = 0;
            
            if (nightProgress === 1) {
                // 第一帧：设定起始价格和目标价格
                const eventChangePercent = State.nextDayChange / 100;
                State.nightTargetPrice = State.price * (1 + eventChangePercent);
                if (State.nightTargetPrice < 0.01) State.nightTargetPrice = 0.01;
                currentNightPrice = State.price; // 从当前价格开始
                change = 0;
            } else {
                // 后续帧：渐进式趋向目标价格，增加波动幅度
                const targetPrice = State.nightTargetPrice;
                const progressRatio = nightProgress / nightDuration; // 0到1的进度
                
                // 基础趋势：逐渐趋向目标价格
                const trendPrice = State.price + (targetPrice - State.price) * progressRatio;
                
                // 增强的随机波动：根据事件强度调整波动幅度
                const eventMagnitude = Math.abs(State.nextDayChange) / 100; // 事件强度
                const volatilityMultiplier = Math.max(0.02, eventMagnitude * 0.3); // 最小2%，最大30%的波动
                
                // 添加周期性波动，让走势更有趣
                const cyclicWave = Math.sin(nightProgress * 0.1) * volatilityMultiplier * 0.5;
                const randomWave = (Math.random() - 0.5) * volatilityMultiplier;
                
                // 合成最终价格
                const totalWave = cyclicWave + randomWave;
                currentNightPrice = trendPrice * (1 + totalWave);
                
                if (currentNightPrice < 0.01) currentNightPrice = 0.01;
                change = currentNightPrice - (State.nightHistory[State.nightHistory.length - 1] || State.price);
            }
            
            State.nightHistory.push(currentNightPrice);
            
            // Keep history length manageable for drawing
            if (State.nightHistory.length > canvas.width / 5) {
                State.nightHistory.shift();
            }
            
            // 2. Draw K-Line (Simplified as Line chart for smooth animation)
            ctx.beginPath();
            ctx.strokeStyle = change >= 0 ? '#4ade80' : '#ef4444';
            ctx.lineWidth = 4;
            
            // Map price to screen Y - 调整缩放让变化更明显
            // Dynamic scale with enhanced range
            let minP = Math.min(...State.nightHistory, State.price);
            let maxP = Math.max(...State.nightHistory, State.price);
            
            // 确保有足够的价格范围显示
            const priceRange = maxP - minP;
            if (priceRange < State.price * 0.05) { // 如果变化太小，强制扩大范围
                const center = (minP + maxP) / 2;
                const expandedRange = State.price * 0.05; // 至少5%的价格范围
                minP = center - expandedRange / 2;
                maxP = center + expandedRange / 2;
            } else {
                // 正常情况下稍微扩大边界，让图表更清晰
                minP *= 0.98;
                maxP *= 1.02;
            }
            
            const range = maxP - minP;
            const getY = (p) => canvas.height - ((p - minP) / range) * (canvas.height * 0.7) - (canvas.height * 0.15);
            
            for (let i = 0; i < State.nightHistory.length; i++) {
                const x = (i / State.nightHistory.length) * (canvas.width - 100); // Leave room for bed
                const y = getY(State.nightHistory[i]);
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();
            
            // 3. Draw Bed & Character
            const bedX = canvas.width - 100;
            const bedY = getY(currentNightPrice);
            drawBed(ctx, bedX, bedY, change, State.amount > 0);
            
            // 4. Update HUD PnL - 基于当前价格计算实时PnL
            const currentTotalAssets = State.cash + (State.amount * currentNightPrice);
            const pnlPercent = ((currentTotalAssets - State.nightStartVal) / State.nightStartVal * 100).toFixed(2);
            const pnlEl = document.getElementById('night-pnl');
            pnlEl.innerText = (pnlPercent > 0 ? "+" : "") + pnlPercent + "%";
            pnlEl.className = `text-3xl pixel-font font-bold ${pnlPercent >= 0 ? 'text-green-400' : 'text-red-400'}`;
            
            // 5. Special Events / Particles
            if (Math.abs(pnlPercent) > 10 && State.amount > 0) {
                // Happy / Fireworks for big moves
                if (Math.random() > 0.95) createFirework(bedX, bedY);
            }
            updateParticles();
            
            // 6. Danmaku Logic (Random Events)
            if (Math.random() > 0.98) {
                spawnDanmaku();
            }
            
            // Loop or End Night
            if (nightProgress < nightDuration) {
                animationId = requestAnimationFrame(animateNight);
            } else {
                // 夜晚结束，应用最终价格变动
                endNight();
            }
        }

        function drawBed(ctx, x, y, delta, hasCoin) {
            ctx.save();
            ctx.translate(x, y);
            
            // Determine Mood
            let mood = 'sleep'; // neutral
            if (hasCoin) {
                if (delta > 0.5) mood = 'rocket'; // Mooning
                else if (delta < -0.5) mood = 'panic'; // Crash
            } else {
                // Short/Empty logic
                if (delta < -0.5) mood = 'smug'; // Dodged bullet
                else if (delta > 0.5) mood = 'cry'; // Missed out
            }
            
            // Bed Base
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(-20, 10, 40, 10); // Frame
            ctx.fillStyle = '#FFF';
            ctx.fillRect(-18, 5, 36, 8); // Mattress
            ctx.fillStyle = '#DDD';
            ctx.fillRect(10, 0, 10, 8); // Pillow
            
            // Character
            if (mood === 'rocket') {
                // Rocket Bed!
                ctx.fillStyle = 'orange';
                ctx.fillRect(-25, 15, 50, 10); // Fire
                // Happy Guy
                drawGuy(ctx, 0, 0, '^_^');
            } else if (mood === 'panic') {
                // Tilted Bed
                ctx.rotate(Math.PI / 4);
                drawGuy(ctx, 0, 0, 'O_O');
            } else if (mood === 'smug') {
                drawGuy(ctx, 0, 0, '-_-'); // Sleeping peacefully while world burns
                // Shield effect
                ctx.strokeStyle = '#00f3ff';
                ctx.beginPath();
                ctx.arc(0, 5, 30, 0, Math.PI*2);
                ctx.stroke();
            } else if (mood === 'cry') {
                drawGuy(ctx, 0, 0, 'T_T');
            } else {
                drawGuy(ctx, 0, 0, 'zZZ');
            }
            
            ctx.restore();
        }

        function drawGuy(ctx, x, y, face) {
            ctx.fillStyle = '#fca5a5'; // Skin
            ctx.fillRect(-5, -10, 10, 10); // Head
            ctx.fillStyle = '#3b82f6'; // PJ
            ctx.fillRect(-8, 0, 25, 5); // Body lying down
            
            // Face text (lazy pixel art)
            ctx.fillStyle = '#000';
            ctx.font = '10px monospace';
            ctx.fillText(face, -5, -2);
        }

        function createFirework(x, y) {
            for(let i=0; i<10; i++) {
                particles.push({
                    x: x, y: y,
                    vx: (Math.random() - 0.5) * 10,
                    vy: (Math.random() - 0.5) * 10,
                    life: 50,
                    color: Math.random() > 0.5 ? '#fbbf24' : '#ff00ff'
                });
            }
            AudioSys.explosion();
        }

        function updateParticles() {
            for(let i=particles.length-1; i>=0; i--) {
                const p = particles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.vy += 0.2; // gravity
                p.life--;
                
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x, p.y, 4, 4);
                
                if(p.life <= 0) particles.splice(i, 1);
            }
        }

        function spawnDanmaku() {
            const texts = ["Hold!", "To the Moon!", "Scam!", "HODL", "Buy the dip", "RIP Shorts", "Elon??"];
            const text = texts[Math.floor(Math.random()*texts.length)];
            const el = document.createElement('div');
            el.className = "danmaku text-white font-bold pixel-font";
            el.innerText = text;
            el.style.top = Math.random() * 200 + "px";
            el.style.color = Math.random() > 0.5 ? "#4ade80" : "#ef4444";
            document.getElementById('danmaku-container').appendChild(el);
            setTimeout(() => el.remove(), 4000);
        }

        function endNight() {
            // 1. 计算新价格：Price_today = Price_yesterday * (1 + 波动系数R)
            const priceYesterday = State.price;
            const changePercent = State.nextDayChange / 100; // 转换为小数
            State.price = priceYesterday * (1 + changePercent);
            
            // 确保价格不为负
            if (State.price < 0.01) State.price = 0.01;
            
            // 2. 计算总资产：Total_today = Cash + (Amount * Price_today)
            const totalToday = State.cash + (State.amount * State.price);
            
            // 3. 计算昨晚盈亏：PnL = Amount * (Price_today - Price_yesterday)
            State.lastNightPnL = State.amount * (State.price - priceYesterday);
            
            // 4. 计算昨晚盈亏百分比：PnL% = (PnL / Total_yesterday) * 100%
            if (State.totalAssetsYesterday > 0) {
                State.lastNightPnLPercent = (State.lastNightPnL / State.totalAssetsYesterday) * 100;
            } else {
                State.lastNightPnLPercent = 0;
            }
            
            // 5. 更新统计数据
            State.totalHistory.push(totalToday);
            State.minTotalReached = Math.min(State.minTotalReached, totalToday);
            State.maxTotalReached = Math.max(State.maxTotalReached, totalToday);
            
            // 计算最大回撤
            if (State.maxTotalReached > 0) {
                const currentDrawdown = (State.maxTotalReached - totalToday) / State.maxTotalReached;
                State.stats.maxDrawdown = Math.max(State.stats.maxDrawdown, currentDrawdown);
            }
            
            // 检查幸运事件（利好事件且有持仓）
            if (State.currentEvent && State.currentEvent.type.includes('利好') && State.amount > 0) {
                State.stats.luckEvents++;
            }
            
            // 计算平均alpha
            if (State.alphaHistory.length > 0) {
                const sumAlpha = State.alphaHistory.reduce((sum, alpha) => sum + Math.abs(alpha), 0);
                State.stats.avgAlpha = sumAlpha / State.alphaHistory.length;
            }
            
            // 6. 更新昨日总资产为今日总资产
            State.totalAssetsYesterday = totalToday;
            
            // 7. 记录价格历史
            State.history.push(State.price);
            
            // 8. 检查是否爆仓（提前结束游戏）
            if (totalToday <= 10) {
                showEnding(true); // 传入爆仓标志
                return;
            }
            
            // 9. 进入下一天
            State.day++;
            if (State.day > State.maxDays) {
                showEnding(false);
            } else {
                switchScreen('day');
                updateDayUI();
            }
        }

        function showEnding(isBankrupt = false) {
            switchScreen('end');
            
            const total = Math.floor(State.cash + (State.amount * State.price));
            document.getElementById('final-score').innerText = total;
            
            const roi = ((total - 1000) / 1000) * 100;
            const roiEl = document.getElementById('roi-text');
            roiEl.innerText = `ROI: ${roi.toFixed(1)}%`;
            roiEl.className = roi >= 0 ? "text-green-400 text-lg" : "text-red-400 text-lg";
            
            // 终局唯一代号判定 (Exclusive Waterfall Logic)
            let title = "幸存者";
            let desc = "平稳度过了7天的考验，虽然平凡但也是一种成就。";
            
            // 第一阶段：生存与灾难 (优先判定死者)
            if (total <= 10 && State.currentEvent && State.currentEvent.type === '利空-A' && State.day === 7) {
                title = "协议陪葬者";
                desc = "在重入攻击中失去了一切，与协议共同沉没。";
            } else if (total <= 10 && State.day <= 2 && State.eventHistory.some(h => h.day === 1 && h.event.type === '黑天鹅')) {
                title = "首席送财官";
                desc = "第一天就遇到黑天鹅，两天内就爆仓离场。";
            } else if (total <= 10) {
                title = "天台常客";
                desc = "资产归零，准备好从天台一跃而下了吗？";
            }
            // 第二阶段：极端/存疑操作
            else if (roi < -90 && State.amount > 0) {
                title = "空气币收藏家";
                desc = "亏损90%还不止损，你是在收藏空气币吗？";
            } else if (State.stats.avgAlpha < 0.01) {
                title = "观察者模式";
                desc = "全程基本空仓，你是来看戏的吗？";
            }
            // 第三阶段：顶级荣誉
            else if (roi > 250 && State.stats.luckEvents >= 2) {
                title = "欧皇降世";
                desc = "天选之子，运气爆棚，连续踩中利好事件。";
            } else if (roi > 150 && State.stats.timingScore >= 90 && State.stats.maxDrawdown < 0.25) {
                title = "量化之神";
                desc = "完美的择时，精准的风控，你就是传说中的量化大神。";
            } else if (checkBottomFisher() && roi > 0) {
                title = "抄底教父";
                desc = "在暴跌中逆势抄底，最终获得正收益，胆识过人。";
            }
            // 第四阶段：风格表现
            else if (State.minTotalReached < 200 && roi > 0) {
                title = "回本大师";
                desc = "曾经深度亏损，但最终成功回本，韧性十足。";
            } else if (State.stats.changeCount <= 1 && State.stats.avgAlpha > 0.8 && roi > 0) {
                title = "钻石之手";
                desc = "HODL就是信仰，一买到底，钻石般坚硬的双手。";
            } else if (roi > 80 && State.stats.timingScore > 70) {
                title = "趋势猎人";
                desc = "精准捕捉市场趋势，择时能力出众。";
            } else if (State.stats.timingScore < 30 && roi < -50) {
                title = "精准反向师";
                desc = "每次操作都踩在节点上，堪称反向指标教科书。";
            } else if (State.stats.changeCount > 10) {
                title = "持仓管理员";
                desc = "频繁调仓，忙得不亦乐乎，但效果如何就另说了。";
            }
            
            // 如果爆仓，显示墓碑效果
            if (isBankrupt) {
                document.querySelector('.bg-slate-900').classList.add('bg-gray-900');
                document.querySelector('.border-white').classList.add('border-gray-600');
                // 添加墓碑图标
                const tombstone = document.createElement('div');
                tombstone.innerHTML = '⚰️';
                tombstone.className = 'text-6xl mb-4';
                document.querySelector('#end-screen .w-full').insertBefore(tombstone, document.querySelector('#end-screen h2'));
            }
            
            // Stats for chart (0-100)
            const Greed = Math.min(100, State.stats.allIns * 25);
            const Fear = Math.min(100, State.stats.panicSells * 30); 
            const Luck = Math.min(100, (State.stats.luckEvents / 3) * 100);
            const Guts = Math.min(100, State.stats.timingScore);
            
            document.getElementById('bar-greed').style.height = Greed + "%";
            document.getElementById('bar-fear').style.height = Fear + "%";
            document.getElementById('bar-luck').style.height = Luck + "%";
            document.getElementById('bar-guts').style.height = Guts + "%";
            
            document.getElementById('player-title').innerText = title;
            document.getElementById('flavor-text').innerText = desc;
        }
        
        // 检查是否为抄底教父
        function checkBottomFisher() {
            for (let i = 0; i < State.eventHistory.length; i++) {
                const event = State.eventHistory[i];
                const alpha = State.alphaHistory[i] || 0;
                
                // 检查是否在大跌日(R < -40%)进行大幅买入(alpha > 0.8)
                if (event.event.changePercent < -40 && alpha > 0.8) {
                    return true;
                }
            }
            return false;
        }

        // Init - 确保DOM完全加载后再初始化
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initGame);
        } else {
            initGame();
        }
    </script>
</body>
</html>